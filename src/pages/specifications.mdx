# Cahier des charges

## FonctionnalitÃ©s Ã  choisir


- [ ]  CompatibilitÃ© avec le protocole vanilla
    - [ ]  ce layer doit-il Ãªtre un module ? (du genre traduction la polymer?)
    - [ ]  utilisation de raknetify ?
- [ ]  Pas de limitations techniques sur la high limit
- [x]  Ã‰crit en Rust
- [ ]  Dois pouvoir Ãªtre multithreadable/mutli threadÃ© (voire async ?)
- [ ]  Light engine
- [ ]  Dois supporter des add-ons (le contenu de Minecraft vanilla pourrait Ãªtre lui-mÃªme un add-on, le soft du serveur n'Ã©tant qu'un moteur Ã  â€œMinecraftâ€)
- [ ]  Support de plugins (voir Nomenclature):
    - [ ]  lib dynamique
    - [ ]  en lua
    - [ ]  en wren
- [ ]  RÃ©-ImplÃ©mentation du gÃ©nÃ©rateur de chunks de MC ?
    - [ ]  (module ?)
    - [ ]  Demander Ã  l'auteur de c2me s'il veut bien participer ?
- [ ]  Ã‰crire notre propre ECS ou utiliser bevy ?

## Micro-Services


- [ ]  1 service de proxy (velocity like)
- [ ]  1 service d'auth (qui tapera soit sur les serveurs de mojang, soit custom)
- [ ]  1 Ã  N service de stockage des mondes
    - [ ]  clusterisable
    - [ ]  load balancing
    - [ ]  Importeur / exporteur de monde entre le format MC et le format custom
- [ ]  1 Ã  N service de logique des mondes

## Projets

- [ ]  Lib de paquets
- [ ]  Lib de communication interservices

## Base de connaissance

- [x]  organisation
    - [ ]  libs
    - [ ]  serveurs
    - [ ]  docs
- [x]  la nouvelle base de connaissance (pour remplacer notion)
- [x]  dev blog

## Points techniques

### Langage utilisÃ©

Rust sera utilisÃ© dans tout le projet. Lâ€™ensemble du projet sera rangÃ© dans un workspace cargo pour plus de simplicitÃ©.

Voici quelques ressources disponibles :

- si vous souhaitez apprendre le langage : https://github.com/rust-lang/rustlings
- si vous cherchez la documentation de Rust : [The Rust Programming Language - The Rust Programming Language](https://doc.rust-lang.org/book/title-page.html)
- si vous cherchez des librairies :
	- [Docs.rs](https://docs.rs/)
	- [Lib.rs â€” home for Rust crates](https://lib.rs/)

## Nomenclature

### Plugins

Archive/dossier contenant lâ€™ensemble des ressources nÃ©cessaires pour charger un projet

### Modules

Fichier lua ou shared libs qui contiennent la logique du plugin (blocs, items, etc.)

### Assets

Ressources supplÃ©mentaires utiles pour le plugin :

- Convention commentaires rust : [Comments - The Rust Reference](https://doc.rust-lang.org/reference/comments.html)
- Conventions nommage rust : 
    - [Rust #5: Naming conventions](https://dev.to/cthutu/rust-5-naming-conventions-3cjf)
    - [Naming - Rust API Guidelines](https://rust-lang.github.io/api-guidelines/naming.html)

## Chunks

- Un chunk est une unitÃ© de 16Ã—16Ã—16 blocks, soit 4096 blocks au total, il contiens:
    - ses propres coordonnÃ©es relatives dans le monde
    - des flags (voir plus bas)
    - les id des blocks qui le compose
    - un array de 2048 octets pour les donnÃ©es de lumiÃ¨re (soit 4 bits par niveau de lumiÃ¨re)
    - la liste des (id) entitÃ©s (+tileEntity?) qui s'y trouvent.
- doit toujours avoir une taille statique en mÃ©moire, cependant n'avoir aucune forme de compression serait une Ã©norme perte d'espace (il y a beaucoup de chunks composÃ© d'Ã  peine une dizaine de blocks, voir que d'un block uniquement), afin de palier Ã  ce problÃ¨me, 2 implÃ©mentations d'un chunks :
    - une version compressÃ©e avec une palette qui traduit les blocks sur 4 bits
    - la reprÃ©sentation sur 4 bytes (cela permet de diviser par deux lÃ  taille d'un chunks en mÃ©moire pour des id globaux d'un bloc sur 1 octet, par 4 si les blocks sont reprÃ©sentÃ©s sur 2 octets).
- un chunks dois porter en en-tÃªte les flags suivant :
    - est-ce un chunk null (un simple trou dans le vecteur de stockage qui peut Ãªtre refill
    - est-ce qu'il y a besoin d'appliquer du random-tick speed
    - est-ce qu'il soit Ãªtre tickÃ© ?
- un chunk compressÃ© en mÃ©moire ne doit pas nÃ©cessiter de traitement complexe. Les chunks nÃ©cessitant une update rÃ©guliÃ¨re peuvent Ãªtre convertis vers un chunk non compressÃ©
- Le serveur possÃ¨de deux vecteurs de chunks chargÃ©s en mÃ©moire, pour les versions compressÃ©es et non compressÃ©es, pour les accÃ¨s au chunks en fonction de leurs coordonnÃ©es, une map liant position Ã  l'index du chunk dans le vecteur devra Ãªtre utilisÃ©e. La vectorisation des chunks garantie que le tick soit rapide et limite les cache miss
- pourquoi utiliser uniquement deux types de chunks : des variantes de palettes sur 5, 6, 7 et 8 bits augmenterais beaucoup la complexitÃ© du programme, avec une lÃ©gÃ¨re diminution de la quantitÃ© de mÃ©moire utilisÃ©e mais aussi une perte en vitesse lors de l'update, car il faudrait nÃ©gocier avec plus d'objets de diffÃ©rentes tailles
- tous les chunks compressÃ© en mÃ©moire doivent avoir la mÃªme taille, il en va de mÃªme avec les chunks non compressÃ©es

## Blocks

- un block placÃ© nâ€™est qu'un entier sur 4 bytes (son id) dans un chunk
- plusieurs variations d'un block sont des blocks diffÃ©rents, il n'y a pas de systÃ¨me de metadata Ã  part les tile entity
- les fonctions associÃ©s aux blocks (tick, update, on break, etc) sont toutes stockÃ©es dans un array, l'id du block devra Ãªtre utilisÃ©e comme index pour rÃ©cupÃ©rer ces fonctions
- il doit Ãªtre possible de crÃ©er des blocks avec une plage d'id contiguÃ« pour tester facilement si un block fait parti d'un groupe (si il est compris dans la plage d'id), utile pour gÃ©rer des variations d'un block (redstone, piston, escalier, blocks waterlogged, etc)

## GÃ©nÃ©ration du monde

### Ressources:

<iframe width="854" height="480" src="https://www.youtube.com/embed/YyVAaJqYAfE" title="THIS is how Minecraft Works ğŸ’â›ï¸" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe>
<iframe width="854" height="480" src="https://www.youtube.com/embed/ob3VwY4JyzE" title="Reinventing Minecraft world generation by Henrik Kniberg" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe>
